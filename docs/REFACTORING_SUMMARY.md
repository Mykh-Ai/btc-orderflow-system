# üéØ –ö–æ—Ä–æ—Ç–∫–∏–π –ó–≤—ñ—Ç –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É executor.py

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è  
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∞ –µ–∫–æ–Ω–æ–º—ñ—è:** **1570 —Ä—è–¥–∫—ñ–≤** (50.8% –∑ executor.py)  
**–û—Ü—ñ–Ω–∫–∞ —á–∞—Å—É:** 4 —Ç–∏–∂–Ω—ñ  
**–†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É:** –°–µ—Ä–µ–¥–Ω—ñ–π (–∑–∞ —É–º–æ–≤–∏ –ø–æ–∫—Ä–æ–∫–æ–≤–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)

---

## üìä –©–æ –ó–Ω–∞–π–¥–µ–Ω–æ

```
executor.py: 3093 —Ä—è–¥–∫–∏
‚îú‚îÄ‚îÄ manage_v15_position()  1207 —Ä—è–¥–∫—ñ–≤ (39.0%) üî¥ –ö–†–ò–¢–ò–ß–ù–û
‚îú‚îÄ‚îÄ main()                  553 —Ä—è–¥–∫–∏ (17.9%) üü° –í–ê–ñ–õ–ò–í–û
‚îú‚îÄ‚îÄ sync_from_binance()     430 —Ä—è–¥–∫—ñ–≤ (13.9%) üü° –í–ê–ñ–õ–ò–í–û
‚îú‚îÄ‚îÄ ENV config              127 —Ä—è–¥–∫—ñ–≤ ( 4.1%) üü¢ –õ–ï–ì–ö–û
‚îî‚îÄ‚îÄ helpers (~20 —Ñ—É–Ω–∫—Ü—ñ–π)   776 —Ä—è–¥–∫—ñ–≤ (25.1%) üü¢ –õ–ï–ì–ö–û
```

---

## üöÄ –©–æ –ú–æ–∂–Ω–∞ –ó—Ä–æ–±–∏—Ç–∏ –ë–ï–ó–ü–ï–ß–ù–û —ñ –®–í–ò–î–ö–û

### ‚úÖ –§–ê–ó–ê 4: Helpers + Config (2-3 –¥–Ω—ñ) ‚Äî **260 —Ä—è–¥–∫—ñ–≤**

**–ù–æ–≤–∏–π –º–æ–¥—É–ª—å:** `executor_mod/config.py`
- –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ `_get_bool()`, `_get_int()`, `_get_float()`, `_get_str()`
- –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –ø–æ–±—É–¥–æ–≤—É `ENV` dict
- **–†–∏–∑–∏–∫:** ‚ö™ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π

**–ù–æ–≤–∏–π –º–æ–¥—É–ª—å:** `executor_mod/helpers.py`
- `read_tail_lines()` ‚Äî 31 —Ä—è–¥–æ–∫
- `_avg_fill_price()` ‚Äî 20 —Ä—è–¥–∫—ñ–≤
- `_oid_int()`, `_as_f()`, `now_utc()`, `iso_utc()` —Ç–∞ —ñ–Ω—à—ñ
- **–†–∏–∑–∏–∫:** ‚ö™ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π

**–ß–æ–º—É –ø–æ—á–∞—Ç–∏ –∑ —Ü—å–æ–≥–æ:**
- üü¢ –ß–∏—Å—Ç—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –±–µ–∑ –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
- üü¢ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏
- üü¢ –®–≤–∏–¥–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü—ñ—ó –∫–æ–º–∞–Ω–¥–∏

---

## üí™ –©–æ –î–∞—Å—Ç—å –ù–ê–ô–ë–Ü–õ–¨–®–£ –ï–ö–û–ù–û–ú–Ü–Æ

### ‚úÖ –§–ê–ó–ê 1: manage_v15_position ‚Üí position_manager.py (1-2 —Ç–∏–∂–Ω—ñ) ‚Äî **810 —Ä—è–¥–∫—ñ–≤**

**–ö—Ä–æ–∫ 1.1:** –í–∏—Ç—è–≥—Ç–∏ `_close_slot()` ‚Äî **720 —Ä—è–¥–∫—ñ–≤**
```python
# executor_mod/position_manager.py
def close_position_slot(st, pos, symbol, reason, ...) -> None:
    """Extracted 718-line monster from manage_v15_position"""
```
- ‚úÖ –í–∂–µ —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∞ —è–∫ –≤–∫–ª–∞–¥–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è
- ‚úÖ –ß—ñ—Ç–∫—ñ inputs/outputs
- ‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±—É—î —Ä–µ—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

**–ö—Ä–æ–∫ 1.2:** –í–∏—Ç—è–≥—Ç–∏ error handling ‚Äî **340 —Ä—è–¥–∫—ñ–≤**
```python
# executor_mod/position_manager.py
def is_unknown_order_error(e: Exception) -> bool:
    """322 lines of error classification logic"""

def cancel_ignore_unknown(order_id, api) -> Optional[Exception]:
    """18 lines of safe cancel"""
```

**–ö—Ä–æ–∫ 1.3:** –í–∏—Ç—è–≥—Ç–∏ watchdogs ‚Üí `watchdogs.py` ‚Äî **150 —Ä—è–¥–∫—ñ–≤**
```python
# executor_mod/watchdogs.py
def sl_watchdog(pos, symbol, orders, ENV, api, log_fn) -> None:
def tp_watchdog(pos, symbol, orders, ENV, api, log_fn) -> None:
```
- ‚ö†Ô∏è –í–∂–µ —î —Ç–µ—Å—Ç–∏: `test/test_sl_watchdog.py`, `test/test_tp_watchdog.py`

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –ü–ª–∞–Ω

### üèÅ –°—Ç–∞—Ä—Ç: –§–ê–ó–ê 4 (Quick Win)
**–¢–∏–∂–¥–µ–Ω—å 1 (2-3 –¥–Ω—ñ —Ä–æ–±–æ—Ç–∏):**
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `executor_mod/config.py`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `executor_mod/helpers.py`
- [ ] –û–Ω–æ–≤–∏—Ç–∏ imports –≤ executor.py
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–µ—Å—Ç–∏
- [ ] Merge ‚Üí tag `v2.1-phase4`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** -260 —Ä—è–¥–∫—ñ–≤, –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å —É –ø—Ä–æ—Ü–µ—Å—ñ ‚úÖ

---

### üî• –û—Å–Ω–æ–≤–Ω–∞ –†–æ–±–æ—Ç–∞: –§–ê–ó–ê 1.1 (Biggest Bang for Buck)
**–¢–∏–∂–¥–µ–Ω—å 2 (3-4 –¥–Ω—ñ —Ä–æ–±–æ—Ç–∏):**
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `executor_mod/position_manager.py`
- [ ] –í–∏—Ç—è–≥—Ç–∏ `close_position_slot()` –∑ `manage_v15_position._close_slot()`
- [ ] Dependency injection pattern (—è–∫ –≤ `.github/copilot-instructions.md`)
- [ ] Regression tests
- [ ] Staging test –∑ real API
- [ ] Merge ‚Üí tag `v2.1-phase1.1`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** -720 —Ä—è–¥–∫—ñ–≤, `manage_v15_position()` –∑–º–µ–Ω—à–µ–Ω–æ –∑ 1207 –¥–æ ~487 —Ä—è–¥–∫—ñ–≤ ‚úÖ

---

### üéØ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è: –§–ê–ó–ê 1.2 + 1.3
**–¢–∏–∂–¥–µ–Ω—å 3:**
- [ ] –í–∏—Ç—è–≥—Ç–∏ error handling (340 —Ä—è–¥–∫—ñ–≤)
- [ ] –í–∏—Ç—è–≥—Ç–∏ watchdog wrappers (450 —Ä—è–¥–∫—ñ–≤) ‚¨ÖÔ∏è **–û–ù–û–í–õ–ï–ù–û**
  - Core watchdog –≤–∂–µ –≤ `exit_safety.py` (530 —Ä—è–¥–∫—ñ–≤)
  - Wrapper –∫–æ–¥: orchestration, state persistence, market fallback
- [ ] Merge ‚Üí tag `v2.1-phase1`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `manage_v15_position()` —Ç–µ–ø–µ—Ä ~400 —Ä—è–¥–∫—ñ–≤ (–±—É–ª–æ 1207) ‚úÖ

---

### üèÜ –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –§–ê–ó–ê 2 + 3
**–¢–∏–∂–¥–µ–Ω—å 4** (—è–∫—â–æ —î —á–∞—Å):
- Entry flow extraction (300 —Ä—è–¥–∫—ñ–≤)
- Reconciliation extraction (200 —Ä—è–¥–∫—ñ–≤)

---

## üß™ –ö—Ä–∏—Ç–µ—Ä—ñ—ó –£—Å–ø—ñ—Ö—É

–ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó —Ñ–∞–∑–∏:
```bash
‚úÖ python -m pytest test/ -v  # –≤—Å—ñ —Ç–µ—Å—Ç–∏ green
‚úÖ executor.py < 2000 —Ä—è–¥–∫—ñ–≤ (–ø—ñ—Å–ª—è –§–ê–ó–ê 1)
‚úÖ executor.py < 1500 —Ä—è–¥–∫—ñ–≤ (–ø—ñ—Å–ª—è –§–ê–ó–ê 2+3)
‚úÖ staging deploy –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
```

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –ó–∞—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è

### üî¥ –ù–ï —Ä–æ–±–∏—Ç–∏:
- ‚ùå –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç–∏ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –æ–¥—Ä–∞–∑—É
- ‚ùå –ó–º—ñ–Ω—é–≤–∞—Ç–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫—É –ø—ñ–¥ —á–∞—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É
- ‚ùå –ü—Ä–æ–ø—É—Å–∫–∞—Ç–∏ —Ç–µ—Å—Ç–∏
- ‚ùå –î–µ–ø–ª–æ—ó—Ç–∏ –≤ prod –±–µ–∑ staging

### üü¢ –û–±–æ–≤'—è–∑–∫–æ–≤–æ —Ä–æ–±–∏—Ç–∏:
- ‚úÖ Feature branch –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ñ–∞–∑–∏
- ‚úÖ Regression tests –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫—Ä–æ–∫—É
- ‚úÖ Dependency injection pattern (–Ω–µ –ø—Ä—è–º—ñ —ñ–º–ø–æ—Ä—Ç–∏)
- ‚úÖ Backward compatibility (—Å—Ç–∞—Ä—ñ —ñ–º–ø–æ—Ä—Ç–∏ –ø—Ä–∞—Ü—é—é—Ç—å)
- ‚úÖ Staging deploy –ø–µ—Ä–µ–¥ merge

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω–∏–π –†–µ–∑—É–ª—å—Ç–∞—Ç

| –§–∞–π–ª | –î–æ | –ü—ñ—Å–ª—è –§–ê–ó–ê 1 | –ü—ñ—Å–ª—è –≤—Å—ñ—Ö —Ñ–∞–∑ |
|------|-----|--------------|----------------|
| **executor.py** | 3093 | **~1543** | **~1313** |
| manage_v15_position | 1207 | **~400** | **~400** |
| main() | 553 | 553 | **~250** |
| sync_from_binance() | 430 | 430 | **~230** |

**–ù–æ–≤—ñ –º–æ–¥—É–ª—ñ:**
- `position_manager.py` (~900 —Ä—è–¥–∫—ñ–≤)
- `watchdogs.py` (~150 —Ä—è–¥–∫—ñ–≤)
- `config.py` (~160 —Ä—è–¥–∫—ñ–≤)
- `helpers.py` (~100 —Ä—è–¥–∫—ñ–≤)
- `entry_flow.py` (~200 —Ä—è–¥–∫—ñ–≤) ‚Äî –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ
- `reconciliation.py` (~200 —Ä—è–¥–∫—ñ–≤) ‚Äî –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ

---

## üéÅ –ë–æ–Ω—É—Å–∏

1. **–ö—Ä–∞—â–∞ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å** ‚Äî –∫–æ–∂–µ–Ω –º–æ–¥—É–ª—å < 500 —Ä—è–¥–∫—ñ–≤
2. **–ü—Ä–æ—Å—Ç—ñ—à—ñ —Ç–µ—Å—Ç–∏** ‚Äî –º–µ–Ω—à—ñ unit test targets
3. **–õ–µ–≥—à–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞** ‚Äî –∑—Ä–æ–∑—É–º—ñ–ª–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
4. **–®–≤–∏–¥—à–∏–π onboarding** ‚Äî –Ω–æ–≤—ñ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ —à–≤–∏–¥—à–µ —Ä–æ–∑–±–µ—Ä—É—Ç—å—Å—è
5. **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ —Ñ—ñ—á—ñ

---

**–î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç:** [REFACTORING_AUDIT.md](REFACTORING_AUDIT.md)

**–ì–æ—Ç–æ–≤–æ –¥–æ —Å—Ç–∞—Ä—Ç—É?** üöÄ  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** –ü–æ—á–∞—Ç–∏ –∑ –§–ê–ó–ê 4 (—à–≤–∏–¥–∫–∏–π win) ‚Üí –§–ê–ó–ê 1.1 (–Ω–∞–π–±—ñ–ª—å—à–∞ –µ–∫–æ–Ω–æ–º—ñ—è)
